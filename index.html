<script>
const API = "https://nw9ebhwhaj.execute-api.eu-north-1.amazonaws.com/";

async function fetchDevice(deviceId) {
    const res = await fetch(`${API}history/${deviceId}`);
    const raw = await res.json();

    // Normalize fields â†’ ignore extra backend values
    return raw.map(entry => ({
        timestamp: new Date(entry.timestamp),
        water: entry.water ?? 0,
        target: entry.target ?? 0
    }));
}

async function loadHistory() {
    const dataA = await fetchDevice("ESP32_A");
    const dataB = await fetchDevice("ESP32_B");

    const labelsA = dataA.map(x => x.timestamp);
    const labelsB = dataB.map(x => x.timestamp);

    const allLabels = [...labelsA, ...labelsB].sort((a, b) => a - b);

    const waterA  = dataA.map(x => x.water);
    const targetA = dataA.map(x => x.target);

    const waterB  = dataB.map(x => x.water);
    const targetB = dataB.map(x => x.target);

    new Chart(document.getElementById("chart"), {
        type: "line",
        data: {
            labels: allLabels,
            datasets: [
                {
                    label: "ESP32_A Water",
                    data: waterA,
                    borderWidth: 2,
                    borderColor: "blue"
                },
                {
                    label: "ESP32_A Target",
                    data: targetA,
                    borderWidth: 2,
                    borderColor: "lightblue"
                },
                {
                    label: "ESP32_B Water",
                    data: waterB,
                    borderWidth: 2,
                    borderColor: "red"
                },
                {
                    label: "ESP32_B Target",
                    data: targetB,
                    borderWidth: 2,
                    borderColor: "pink"
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { type: "time", time: { unit: "minute" } },
                y: { min: 0, max: 100 }
            }
        }
    });
}

loadHistory();
</script>
