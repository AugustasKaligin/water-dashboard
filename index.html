<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Water System Telemetry Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
 body { font-family: Arial; padding: 20px; background: #e9eef3; }
 h2 { margin-top: 0; }
 .card {
   background: white;
   padding: 20px;
   border-radius: 8px;
   box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
 }
</style>
</head>

<body>
<h2>Water Level & Target History</h2>
<div class="card">
    <canvas id="chart"></canvas>
</div>

<script>
const API = "https://nw9ebhwhaj.execute-api.eu-north-1.amazonaws.com/";

// Fetch all telemetry (but ignore PID)
async function fetchDevice(deviceId) {
    const res = await fetch(`${API}history/${deviceId}`);
    return await res.json();
}

async function loadHistory() {
    const A = await fetchDevice("ESP32_A");
    const B = await fetchDevice("ESP32_B");

    // Extract timestamps
    const labelsA = A.map(x => new Date(x.timestamp));
    const labelsB = B.map(x => new Date(x.timestamp));

    // Merge timestamps for clean x-axis
    const allLabels = [...labelsA, ...labelsB].sort((a, b) => a - b);

    // Extract water + target only
    const waterA  = A.map(x => x.water ?? null);
    const targetA = A.map(x => x.target ?? null);

    const waterB  = B.map(x => x.water ?? null);
    const targetB = B.map(x => x.target ?? null);

    new Chart(document.getElementById("chart"), {
        type: "line",
        data: {
            labels: allLabels,
            datasets: [
                {
                    label: "ESP32_A Water",
                    data: waterA,
                    borderWidth: 2,
                    borderColor: "blue",
                    spanGaps: true
                },
                {
                    label: "ESP32_A Target",
                    data: targetA,
                    borderWidth: 2,
                    borderColor: "lightblue",
                    spanGaps: true
                },
                {
                    label: "ESP32_B Water",
                    data: waterB,
                    borderWidth: 2,
                    borderColor: "red",
                    spanGaps: true
                },
                {
                    label: "ESP32_B Target",
                    data: targetB,
                    borderWidth: 2,
                    borderColor: "pink",
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: "time",
                    time: { unit: "minute" }
                },
                y: {
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

loadHistory();
</script>
</body>
</html>
